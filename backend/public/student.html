<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Student Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark px-3">
  <span class="navbar-brand">Student Dashboard</span>
  <div class="text-white">
    <span id="who"></span>
    <button class="btn btn-sm btn-outline-light ms-2" onclick="logout()">Logout</button>
  </div>
</nav>

<div class="container mt-4">
  <div class="row g-3">
    <div class="col-md-5">
      <div class="card shadow">
        <div class="card-body">
          <h5>Upload Report (PDF)</h5>

          <div class="mb-2">
            <label>Title</label>
            <input id="title" class="form-control" placeholder="Enter title">
          </div>

          <div class="mb-2">
            <label>Type</label>
            <select id="type" class="form-select">
              <option value="internship">Internship</option>
              <option value="project">Final Year Project</option>
              <option value="research">Research</option>
            </select>
          </div>

          <div class="mb-2">
            <label>Domain</label>
            <input id="domain" class="form-control" placeholder="AI / Web / Data Science">
          </div>

          <div class="mb-2">
            <label>Company / Guide</label>
            <input id="companyOrGuide" class="form-control" placeholder="Company or Guide">
          </div>

          <div class="mb-3">
            <label>PDF File</label>
            <input id="pdf" type="file" accept="application/pdf" class="form-control">
          </div>

          <button class="btn btn-primary w-100" onclick="upload()">Upload</button>
          <div id="msg" class="text-danger mt-2"></div>
        </div>
      </div>
    </div>

    <div class="col-md-7">
      <div class="card shadow">
        <div class="card-body">
          <h5>My Submissions</h5>

          <div class="table-responsive">
            <table class="table table-bordered table-sm">
              <thead class="table-dark">
                <tr>
                  <th>Title</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Faculty</th>
                  <th>File</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>

          <h6 class="mt-3">My Reviews</h6>
          <div id="reviews"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API = "http://localhost:5000";
const token = localStorage.getItem("token");

if (!token || localStorage.getItem("role") !== "student") {
  location.href = "index.html";
}

document.getElementById("who").textContent = localStorage.getItem("name") || "Student";

function logout() {
  localStorage.clear();
  location.href = "index.html";
}

async function upload() {
  const msg = document.getElementById("msg");
  msg.textContent = "";

  const file = document.getElementById("pdf").files[0];
  if (!file) {
    msg.textContent = "Please select a PDF file";
    return;
  }

  const fd = new FormData();
  fd.append("title", document.getElementById("title").value.trim());
  fd.append("type", document.getElementById("type").value);
  fd.append("domain", document.getElementById("domain").value.trim());
  fd.append("companyOrGuide", document.getElementById("companyOrGuide").value.trim());
  fd.append("report", file);

  const res = await fetch(API + "/api/submissions/upload", {
    method: "POST",
    headers: { "Authorization": "Bearer " + token },
    body: fd
  });

  const data = await res.json();

  if (!res.ok) {
    msg.textContent = data.message || "Upload failed";
    return;
  }

  alert("Uploaded successfully!");
  loadMine();
}

async function loadMine() {
  const res = await fetch(API + "/api/submissions/mine", {
    headers: { "Authorization": "Bearer " + token }
  });

  const data = await res.json();

  const tbody = document.getElementById("rows");
  tbody.innerHTML = "";

  (data.submissions || []).forEach(s => {
    const faculty = s.assignedFacultyId ? s.assignedFacultyId.name : "-";

    tbody.innerHTML += `
      <tr>
        <td>${s.title}</td>
        <td>${s.type}</td>
        <td>${s.status}</td>
        <td>${faculty}</td>
        <td><a href="${API + s.filePath}" target="_blank">Open PDF</a></td>
      </tr>
    `;
  });

  const rDiv = document.getElementById("reviews");
  rDiv.innerHTML = "";

  (data.reviews || []).forEach(r => {
    rDiv.innerHTML += `
      <div class="border rounded p-2 mb-2 bg-white">
        <b>Decision:</b> ${r.decision} |
        <b>Marks:</b> ${r.marks}<br>
        <b>Remarks:</b> ${r.remarks}<br>
        <small class="text-muted">Reviewed by: ${r.facultyId?.name || ""}</small>
      </div>
    `;
  });
}

loadMine();
</script>

</body>
</html>